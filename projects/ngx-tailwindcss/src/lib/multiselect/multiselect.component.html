<div class="tw-multiselect relative">
  <!-- Label -->
  @if (label) {
    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
      {{ label }}
    </label>
  }

  <!-- Trigger Button -->
  <button
    #triggerButton
    type="button"
    [class]="triggerClasses()"
    [disabled]="disabled"
    (click)="toggleDropdown()"
    [attr.aria-expanded]="isOpen()"
    [attr.aria-haspopup]="true"
  >
    <span class="flex-1 text-left truncate">
      {{ displayText() }}
    </span>

    <div class="flex items-center gap-2">
      @if (selectedValues().size > 0 && !disabled) {
        <button
          type="button"
          class="text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300"
          (click)="clearAll(); $event.stopPropagation()"
          aria-label="Clear all selections"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
      }

      <svg
        class="w-5 h-5 text-slate-400 dark:text-slate-500 transition-transform"
        [class.rotate-180]="isOpen()"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
      </svg>
    </div>
  </button>

  <!-- Dropdown -->
  @if (isOpen()) {
    @if (appendTo === 'body') {
      <div
        [class]="dropdownClasses()"
        [style.top.px]="dropdownPosition()?.top"
        [style.left.px]="dropdownPosition()?.left"
        [style.width.px]="dropdownPosition()?.width"
        [style.position]="'fixed'"
      >
        <ng-container *ngTemplateOutlet="dropdownContent"></ng-container>
      </div>
    } @else {
      <div [class]="dropdownClasses()">
        <ng-container *ngTemplateOutlet="dropdownContent"></ng-container>
      </div>
    }
  }
</div>

<!-- Dropdown Content Template -->
<ng-template #dropdownContent>
  <!-- Filter Input -->
  @if (filter) {
    <div class="px-2 py-2 border-b border-slate-200 dark:border-slate-700">
      <input
        type="text"
        class="w-full px-3 py-1.5 text-sm border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 placeholder:text-slate-400 dark:placeholder:text-slate-500 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 focus:outline-none"
        placeholder="Search..."
        [value]="filterValue()"
        (input)="onFilterInput($event)"
        (click)="$event.stopPropagation()"
      />
    </div>
  }

  <!-- Select All Option -->
  @if (showSelectAll && allOptions().length > 0) {
    <div
      class="px-3 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer border-b border-slate-200 dark:border-slate-700 flex items-center gap-2"
      (click)="toggleSelectAll(); $event.stopPropagation()"
    >
      @if (showCheckbox) {
        <div
          class="flex items-center justify-center w-4 h-4 border-2 rounded transition-colors"
          [class.border-blue-600]="isAllSelected() || isSomeSelected()"
          [class.bg-blue-600]="isAllSelected() || isSomeSelected()"
          [class.border-slate-300]="!isAllSelected() && !isSomeSelected()"
          [class.dark:border-slate-500]="!isAllSelected() && !isSomeSelected()"
        >
          @if (isAllSelected()) {
            <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="3"
                d="M5 13l4 4L19 7"
              />
            </svg>
          }
          @if (isSomeSelected() && !isAllSelected()) {
            <div class="w-2 h-0.5 bg-white"></div>
          }
        </div>
      }
      <span class="font-medium text-slate-900 dark:text-slate-100">Select All</span>
    </div>
  }

  <!-- Grouped Options -->
  @if (groups.length > 0) {
    @for (group of filteredGroups(); track group.label) {
      <div>
        <!-- Group Header -->
        <div
          class="px-3 py-2 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase bg-slate-50 dark:bg-slate-900"
        >
          {{ group.label }}
        </div>

        <!-- Group Options -->
        @for (option of group.options; track option.value) {
          <div
            class="px-3 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer flex items-center gap-2 transition-colors"
            [class.opacity-50]="option.disabled"
            [class.cursor-not-allowed]="option.disabled"
            [class.bg-blue-50]="isSelected(option) && !option.disabled"
            [class.dark:bg-blue-900/30]="isSelected(option) && !option.disabled"
            (click)="toggleOption(option); $event.stopPropagation()"
          >
            @if (showCheckbox) {
              <div
                class="flex items-center justify-center w-4 h-4 border-2 rounded transition-colors"
                [class.border-blue-600]="isSelected(option)"
                [class.bg-blue-600]="isSelected(option)"
                [class.border-slate-300]="!isSelected(option)"
                [class.dark:border-slate-500]="!isSelected(option)"
              >
                @if (isSelected(option)) {
                  <svg
                    class="w-3 h-3 text-white"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="3"
                      d="M5 13l4 4L19 7"
                    />
                  </svg>
                }
              </div>
            }

            @if (option.icon) {
              <span class="text-slate-500 dark:text-slate-400">{{ option.icon }}</span>
            }

            <span
              class="flex-1"
              [class.text-slate-900]="!option.disabled"
              [class.dark:text-slate-100]="!option.disabled"
              [class.text-slate-400]="option.disabled"
              [class.dark:text-slate-500]="option.disabled"
            >
              {{ option.label }}
            </span>
          </div>
        }
      </div>
    }
  } @else {
    <!-- Flat Options -->
    @for (option of filteredOptions(); track option.value) {
      <div
        class="px-3 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer flex items-center gap-2 transition-colors"
        [class.opacity-50]="option.disabled"
        [class.cursor-not-allowed]="option.disabled"
        [class.bg-blue-50]="isSelected(option) && !option.disabled"
        [class.dark:bg-blue-900/30]="isSelected(option) && !option.disabled"
        (click)="toggleOption(option); $event.stopPropagation()"
      >
        @if (showCheckbox) {
          <div
            class="flex items-center justify-center w-4 h-4 border-2 rounded transition-colors"
            [class.border-blue-600]="isSelected(option)"
            [class.bg-blue-600]="isSelected(option)"
            [class.border-slate-300]="!isSelected(option)"
            [class.dark:border-slate-500]="!isSelected(option)"
          >
            @if (isSelected(option)) {
              <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="3"
                  d="M5 13l4 4L19 7"
                />
              </svg>
            }
          </div>
        }

        @if (option.icon) {
          <span class="text-slate-500 dark:text-slate-400">{{ option.icon }}</span>
        }

        <span
          class="flex-1"
          [class.text-slate-900]="!option.disabled"
          [class.dark:text-slate-100]="!option.disabled"
          [class.text-slate-400]="option.disabled"
          [class.dark:text-slate-500]="option.disabled"
        >
          {{ option.label }}
        </span>
      </div>
    }
  }

  <!-- No Results -->
  @if (groups.length > 0 ? filteredGroups().length === 0 : filteredOptions().length === 0) {
    <div class="px-3 py-2 text-sm text-slate-500 dark:text-slate-400 text-center">
      No options found
    </div>
  }
</ng-template>
