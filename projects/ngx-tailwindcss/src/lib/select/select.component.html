<div [class]="containerClasses()">
  @if (label) {
    <label [for]="inputId" [class]="labelClasses()">
      {{ label }}
      @if (required) {
        <span class="text-rose-500 ml-0.5">*</span>
      }
    </label>
  }

  <div class="relative">
    <button
      #triggerButton
      type="button"
      [id]="inputId"
      [class]="triggerClasses()"
      [disabled]="disabled"
      [attr.aria-expanded]="isOpen()"
      [attr.aria-haspopup]="true"
      (click)="toggleDropdown()"
      (keydown)="onKeydown($event)"
    >
      <span [class]="valueDisplayClasses()">
        @if (selectedOption()) {
          {{ selectedOption()?.label }}
        } @else {
          {{ placeholder }}
        }
      </span>
      <svg
        [class]="chevronClasses()"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="2"
      >
        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
      </svg>
    </button>

    <!-- Dropdown for appendTo="self" -->
    @if (isOpen() && appendTo === 'self') {
      <div [class]="dropdownClasses()" role="listbox">
        @if (filter) {
          <div class="p-2 border-b border-slate-200 dark:border-slate-700">
            <input
              type="text"
              class="w-full px-3 py-2 text-sm border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 placeholder-slate-400 dark:placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
              [placeholder]="filterPlaceholder"
              [value]="filterValue()"
              (input)="onFilterInput($event)"
            />
          </div>
        }
        <div class="max-h-60 overflow-auto py-1">
          @if (groups.length > 0) {
            @for (group of filteredGroups(); track group.label) {
              <div>
                <div class="px-4 py-2 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase bg-slate-50 dark:bg-slate-900">
                  {{ group.label }}
                </div>
                @for (option of group.options; track option.value) {
                  <button
                    type="button"
                    [class]="optionClasses(option)"
                    [attr.aria-selected]="isSelected(option)"
                    role="option"
                    (click)="selectOption(option)"
                  >
                    @if (showCheckmark && isSelected(option)) {
                      <svg
                        class="w-4 h-4 mr-2 text-blue-600 flex-shrink-0"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                      </svg>
                    }
                    <span class="truncate">{{ option.label }}</span>
                  </button>
                }
              </div>
            }
            @if (filteredGroups().length === 0) {
              <div class="px-4 py-3 text-sm text-slate-500 dark:text-slate-400 text-center">
                {{ emptyMessage }}
              </div>
            }
          } @else {
            @for (option of filteredOptions(); track option.value) {
              <button
                type="button"
                [class]="optionClasses(option)"
                [attr.aria-selected]="isSelected(option)"
                role="option"
                (click)="selectOption(option)"
              >
                @if (showCheckmark && isSelected(option)) {
                  <svg
                    class="w-4 h-4 mr-2 text-blue-600 flex-shrink-0"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                  </svg>
                }
                <span class="truncate">{{ option.label }}</span>
              </button>
            }
            @if (filteredOptions().length === 0) {
              <div class="px-4 py-3 text-sm text-slate-500 dark:text-slate-400 text-center">
                {{ emptyMessage }}
              </div>
            }
          }
        </div>
      </div>
    }
  </div>

  @if (hint && !error) {
    <span class="block text-xs text-slate-500 dark:text-slate-400 mt-1.5">{{ hint }}</span>
  }
  @if (error) {
    <span class="block text-xs text-rose-600 mt-1.5" role="alert">{{ error }}</span>
  }
</div>

<!-- Dropdown portal for appendTo="body" -->
@if (isOpen() && appendTo === 'body') {
  <div [class]="dropdownClasses()" [ngStyle]="dropdownStyle()" role="listbox">
    @if (filter) {
      <div class="p-2 border-b border-slate-200 dark:border-slate-700">
        <input
          type="text"
          class="w-full px-3 py-2 text-sm border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 placeholder-slate-400 dark:placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
          [placeholder]="filterPlaceholder"
          [value]="filterValue()"
          (input)="onFilterInput($event)"
        />
      </div>
    }
    <div class="max-h-60 overflow-auto py-1">
      @if (groups.length > 0) {
        @for (group of filteredGroups(); track group.label) {
          <div>
            <div class="px-4 py-2 text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase bg-slate-50 dark:bg-slate-900">
              {{ group.label }}
            </div>
            @for (option of group.options; track option.value) {
              <button
                type="button"
                [class]="optionClasses(option)"
                [attr.aria-selected]="isSelected(option)"
                role="option"
                (click)="selectOption(option)"
              >
                @if (showCheckmark && isSelected(option)) {
                  <svg
                    class="w-4 h-4 mr-2 text-blue-600 flex-shrink-0"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                  </svg>
                }
                <span class="truncate">{{ option.label }}</span>
              </button>
            }
          </div>
        }
        @if (filteredGroups().length === 0) {
          <div class="px-4 py-3 text-sm text-slate-500 dark:text-slate-400 text-center">
            {{ emptyMessage }}
          </div>
        }
      } @else {
        @for (option of filteredOptions(); track option.value) {
          <button
            type="button"
            [class]="optionClasses(option)"
            [attr.aria-selected]="isSelected(option)"
            role="option"
            (click)="selectOption(option)"
          >
            @if (showCheckmark && isSelected(option)) {
              <svg
                class="w-4 h-4 mr-2 text-blue-600 flex-shrink-0"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
              </svg>
            }
            <span class="truncate">{{ option.label }}</span>
          </button>
        }
        @if (filteredOptions().length === 0) {
          <div class="px-4 py-3 text-sm text-slate-500 dark:text-slate-400 text-center">
            {{ emptyMessage }}
          </div>
        }
      }
    </div>
  </div>
}
