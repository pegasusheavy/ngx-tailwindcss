<div [class]="containerClasses()">
  <!-- Header -->
  <div class="flex items-center justify-between">
    <div class="flex items-center gap-2">
      <span class="text-xs uppercase tracking-wider text-slate-500">Compressor</span>
      <!-- Activity indicator -->
      <span
        class="w-2 h-2 rounded-full transition-colors"
        [class]="activityColorClass()"
        [title]="'Compression: ' + compressionActivity()"
      ></span>
    </div>
    @if (inputClip() || outputClip()) {
      <button
        type="button"
        class="px-2 py-0.5 rounded text-[10px] bg-red-600 text-white hover:bg-red-500 transition-colors"
        (click)="resetClip('both')"
      >
        CLIP
      </button>
    }
  </div>

  <!-- Meters Section -->
  <div class="flex items-end gap-4">
    <!-- Input Meter -->
    @if (showInputMeter()) {
      <div class="flex flex-col items-center gap-1">
        <div
          class="relative bg-slate-900 rounded overflow-hidden"
          style="width: 24px"
          [style.height.px]="meterHeight()"
        >
          <!-- Meter fill -->
          <div
            class="absolute bottom-0 left-0 right-0 transition-all"
            [class.duration-75]="animated()"
            [style.height.%]="inputMeterPercent()"
            [style.background]="'linear-gradient(to top, rgb(34, 197, 94), rgb(234, 179, 8) 70%, rgb(239, 68, 68) 90%)'"
          ></div>

          <!-- Peak hold line -->
          @if (peakHold()) {
            <div
              class="absolute left-0 right-0 h-0.5 bg-white transition-all"
              [class.duration-75]="animated()"
              [style.bottom.%]="inputPeakPercent()"
            ></div>
          }

          <!-- Threshold line -->
          @if (showThreshold()) {
            <div
              class="absolute left-0 right-0 h-px bg-amber-500"
              [style.bottom.%]="thresholdPercent()"
              title="Threshold"
            ></div>
            <!-- Threshold marker -->
            <div
              class="absolute -right-1 w-2 h-1 bg-amber-500"
              [style.bottom.%]="thresholdPercent()"
            ></div>
          }

          <!-- Clip indicator -->
          @if (inputClip()) {
            <div class="absolute top-0 left-0 right-0 h-2 bg-red-500 animate-pulse"></div>
          }

          <!-- Scale markers -->
          <div class="absolute right-0.5 inset-y-0 flex flex-col justify-between py-1 pointer-events-none">
            <span class="text-[6px] text-white/50">+6</span>
            <span class="text-[6px] text-white/50">0</span>
            <span class="text-[6px] text-white/50">-∞</span>
          </div>
        </div>

        <span class="text-[10px] text-slate-500">IN</span>
        <span class="text-xs font-mono text-slate-400">{{ formatInputLevel() }}</span>
      </div>
    }

    <!-- Gain Reduction Meter -->
    @if (showGainReduction()) {
      <div class="flex flex-col items-center gap-1">
        <div
          class="relative bg-slate-900 rounded overflow-hidden"
          style="width: 32px"
          [style.height.px]="meterHeight()"
        >
          <!-- GR fill (from top) -->
          <div
            class="absolute top-0 left-0 right-0 transition-all"
            [class.duration-75]="animated()"
            [style.height.%]="gainReductionPercent()"
            [style.background]="'linear-gradient(to bottom, rgb(234, 179, 8), rgb(249, 115, 22) 60%, rgb(239, 68, 68) 90%)'"
          ></div>

          <!-- Scale markers -->
          <div class="absolute inset-0 flex flex-col justify-between pointer-events-none py-1">
            <span class="text-[8px] text-slate-500 text-center">0</span>
            <span class="text-[8px] text-slate-500 text-center">-10</span>
            <span class="text-[8px] text-slate-500 text-center">-20</span>
            <span class="text-[8px] text-slate-500 text-center">-30</span>
            <span class="text-[8px] text-slate-500 text-center">-40</span>
          </div>
        </div>

        <span class="text-[10px] text-slate-500">GR</span>
        <span
          class="text-xs font-mono"
          [class.text-amber-400]="Math.abs(internalGainReduction()) < 10"
          [class.text-orange-400]="Math.abs(internalGainReduction()) >= 10 && Math.abs(internalGainReduction()) < 20"
          [class.text-red-400]="Math.abs(internalGainReduction()) >= 20"
        >{{ formatGainReduction() }} dB</span>
      </div>
    }

    <!-- Output Meter -->
    @if (showOutputMeter()) {
      <div class="flex flex-col items-center gap-1">
        <div
          class="relative bg-slate-900 rounded overflow-hidden"
          style="width: 24px"
          [style.height.px]="meterHeight()"
        >
          <!-- Meter fill -->
          <div
            class="absolute bottom-0 left-0 right-0 transition-all"
            [class.duration-75]="animated()"
            [style.height.%]="outputMeterPercent()"
            [style.background]="'linear-gradient(to top, rgb(34, 197, 94), rgb(234, 179, 8) 70%, rgb(239, 68, 68) 90%)'"
          ></div>

          <!-- Peak hold line -->
          @if (peakHold()) {
            <div
              class="absolute left-0 right-0 h-0.5 bg-white transition-all"
              [class.duration-75]="animated()"
              [style.bottom.%]="outputPeakPercent()"
            ></div>
          }

          <!-- Clip indicator -->
          @if (outputClip()) {
            <div class="absolute top-0 left-0 right-0 h-2 bg-red-500 animate-pulse"></div>
          }

          <!-- Scale markers -->
          <div class="absolute left-0.5 inset-y-0 flex flex-col justify-between py-1 pointer-events-none">
            <span class="text-[6px] text-white/50">+6</span>
            <span class="text-[6px] text-white/50">0</span>
            <span class="text-[6px] text-white/50">-∞</span>
          </div>
        </div>

        <span class="text-[10px] text-slate-500">OUT</span>
        <span class="text-xs font-mono text-slate-400">{{ formatOutputLevel() }}</span>
      </div>
    }

    <!-- Compression Curve -->
    @if (showCurve()) {
      <div class="flex flex-col items-center gap-1">
        <canvas
          #curveCanvas
          [width]="curveSize().width"
          [height]="curveSize().height"
          class="rounded border border-slate-700"
        ></canvas>
        <span class="text-[10px] text-slate-500">Transfer Curve</span>
      </div>
    }
  </div>

  <!-- Gain Reduction History Graph -->
  @if (showGrHistory()) {
    <div class="mt-3 pt-3 border-t border-slate-700">
      <div class="flex items-center justify-between mb-1">
        <span class="text-[10px] text-slate-500 uppercase">Gain Reduction History</span>
        <button
          type="button"
          class="text-[10px] text-slate-500 hover:text-slate-400"
          (click)="clearHistory()"
        >
          Clear
        </button>
      </div>
      <canvas
        #grHistoryCanvas
        [width]="grHistorySize().width"
        [height]="grHistorySize().height"
        class="rounded border border-slate-700 w-full"
      ></canvas>
    </div>
  }

  <!-- Settings Display -->
  @if (showSettings()) {
    <div class="grid grid-cols-2 gap-x-4 gap-y-1 mt-2 pt-2 border-t border-slate-700">
      <!-- Threshold -->
      <div class="flex items-center justify-between">
        <span class="text-[10px] text-slate-500 uppercase">Thresh</span>
        <span class="text-xs font-mono text-slate-300">{{ formatThreshold() }}</span>
      </div>

      <!-- Ratio -->
      <div class="flex items-center justify-between">
        <span class="text-[10px] text-slate-500 uppercase">Ratio</span>
        <span class="text-xs font-mono text-slate-300">{{ formatRatio() }}</span>
      </div>

      <!-- Attack/Release in different display modes -->
      @if (showAttackRelease()) {
        @switch (attackReleaseDisplay()) {
          @case ('bars') {
            <!-- Attack with bar -->
            <div class="col-span-2 mt-1">
              <div class="flex items-center justify-between mb-0.5">
                <span class="text-[10px] text-slate-500 uppercase">Attack</span>
                <span class="text-[10px] font-mono text-slate-300">{{ formatAttack() }}</span>
              </div>
              <div class="h-1.5 bg-slate-700 rounded-full overflow-hidden">
                <div
                  class="h-full rounded-full transition-all"
                  [class.bg-green-500]="attackSpeed() === 'fast'"
                  [class.bg-yellow-500]="attackSpeed() === 'medium'"
                  [class.bg-orange-500]="attackSpeed() === 'slow'"
                  [class.bg-red-500]="attackSpeed() === 'very-slow'"
                  [style.width.%]="attackBarPercent()"
                ></div>
              </div>
              <div class="flex justify-between text-[8px] text-slate-600 mt-0.5">
                <span>Fast</span>
                <span>Slow</span>
              </div>
            </div>

            <!-- Release with bar -->
            <div class="col-span-2 mt-1">
              <div class="flex items-center justify-between mb-0.5">
                <span class="text-[10px] text-slate-500 uppercase">Release</span>
                <span class="text-[10px] font-mono text-slate-300">{{ formatRelease() }}</span>
              </div>
              <div class="h-1.5 bg-slate-700 rounded-full overflow-hidden">
                <div
                  class="h-full rounded-full transition-all"
                  [class.bg-green-500]="releaseSpeed() === 'fast'"
                  [class.bg-yellow-500]="releaseSpeed() === 'medium'"
                  [class.bg-orange-500]="releaseSpeed() === 'slow'"
                  [class.bg-red-500]="releaseSpeed() === 'very-slow'"
                  [style.width.%]="releaseBarPercent()"
                ></div>
              </div>
              <div class="flex justify-between text-[8px] text-slate-600 mt-0.5">
                <span>Fast</span>
                <span>Slow</span>
              </div>
            </div>
          }

          @case ('envelope') {
            <!-- Envelope visualization -->
            <div class="col-span-2 mt-2">
              <div class="flex items-center justify-between mb-1">
                <span class="text-[10px] text-slate-500 uppercase">Envelope</span>
                <div class="flex gap-2 text-[10px] font-mono text-slate-400">
                  <span>A: {{ formatAttack() }}</span>
                  <span>R: {{ formatRelease() }}</span>
                </div>
              </div>
              <canvas
                #envelopeCanvas
                [width]="envelopeSize().width"
                [height]="envelopeSize().height"
                class="rounded border border-slate-700 w-full"
              ></canvas>
            </div>
          }

          @case ('graph') {
            <!-- Detailed A/R graph with labeled regions -->
            <div class="col-span-2 mt-2">
              <div class="flex items-center gap-4">
                <!-- Attack region -->
                <div class="flex-1">
                  <div class="flex items-center justify-between mb-1">
                    <span class="text-[9px] text-green-500/80 uppercase font-medium">Attack</span>
                    <span class="text-[10px] font-mono text-green-400">{{ formatAttack() }}</span>
                  </div>
                  <div class="relative h-8 bg-slate-800 rounded overflow-hidden">
                    <!-- Attack curve visualization -->
                    <svg class="w-full h-full" viewBox="0 0 100 32" preserveAspectRatio="none">
                      <path
                        d="M 0 32 Q 20 32, 40 8 Q 60 0, 100 0"
                        fill="none"
                        stroke="rgb(34, 197, 94)"
                        stroke-width="2"
                      />
                      <path
                        d="M 0 32 Q 20 32, 40 8 Q 60 0, 100 0 L 100 32 Z"
                        fill="rgba(34, 197, 94, 0.2)"
                      />
                    </svg>
                    <!-- Speed indicator -->
                    <div class="absolute bottom-0 left-0 right-0 h-1 bg-slate-700">
                      <div
                        class="h-full bg-green-500"
                        [style.width.%]="attackBarPercent()"
                      ></div>
                    </div>
                  </div>
                  <span class="text-[8px] text-slate-500">{{ attackSpeed() | titlecase }}</span>
                </div>

                <!-- Release region -->
                <div class="flex-1">
                  <div class="flex items-center justify-between mb-1">
                    <span class="text-[9px] text-amber-500/80 uppercase font-medium">Release</span>
                    <span class="text-[10px] font-mono text-amber-400">{{ formatRelease() }}</span>
                  </div>
                  <div class="relative h-8 bg-slate-800 rounded overflow-hidden">
                    <!-- Release curve visualization -->
                    <svg class="w-full h-full" viewBox="0 0 100 32" preserveAspectRatio="none">
                      <path
                        d="M 0 0 Q 40 0, 60 24 Q 80 32, 100 32"
                        fill="none"
                        stroke="rgb(234, 179, 8)"
                        stroke-width="2"
                      />
                      <path
                        d="M 0 0 Q 40 0, 60 24 Q 80 32, 100 32 L 100 0 Z"
                        fill="rgba(234, 179, 8, 0.2)"
                      />
                    </svg>
                    <!-- Speed indicator -->
                    <div class="absolute bottom-0 left-0 right-0 h-1 bg-slate-700">
                      <div
                        class="h-full bg-amber-500"
                        [style.width.%]="releaseBarPercent()"
                      ></div>
                    </div>
                  </div>
                  <span class="text-[8px] text-slate-500">{{ releaseSpeed() | titlecase }}</span>
                </div>
              </div>
            </div>
          }

          @default {
            <!-- Simple text display (none) -->
            <div class="flex items-center justify-between">
              <span class="text-[10px] text-slate-500 uppercase">Attack</span>
              <span class="text-xs font-mono text-slate-300">{{ formatAttack() }}</span>
            </div>

            <div class="flex items-center justify-between">
              <span class="text-[10px] text-slate-500 uppercase">Release</span>
              <span class="text-xs font-mono text-slate-300">{{ formatRelease() }}</span>
            </div>
          }
        }
      }

      <!-- Knee -->
      @if (effectiveSettings().knee > 0) {
        <div class="flex items-center justify-between">
          <span class="text-[10px] text-slate-500 uppercase">Knee</span>
          <span class="text-xs font-mono text-slate-300">{{ effectiveSettings().knee }} dB</span>
        </div>
      }

      <!-- Makeup Gain -->
      @if (effectiveSettings().makeupGain !== 0) {
        <div class="flex items-center justify-between">
          <span class="text-[10px] text-slate-500 uppercase">Makeup</span>
          <span class="text-xs font-mono text-slate-300">
            {{ effectiveSettings().makeupGain > 0 ? '+' : '' }}{{ effectiveSettings().makeupGain }} dB
          </span>
        </div>
      }
    </div>
  }

  <!-- Vintage variant specific A/R visualization -->
  @if (variant() === 'vintage' && showAttackRelease() && attackReleaseDisplay() === 'none') {
    <div class="mt-2 pt-2 border-t border-amber-800/30">
      <div class="flex items-center gap-4">
        <!-- Attack indicator -->
        <div class="flex-1">
          <div class="flex items-center justify-between mb-1">
            <span class="text-[9px] text-amber-600/80 uppercase">Attack</span>
            <span class="text-[10px] font-mono text-amber-400">{{ formatAttack() }}</span>
          </div>
          <div class="h-1 bg-slate-800 rounded-full overflow-hidden">
            <div
              class="h-full bg-amber-500 transition-all"
              [style.width.%]="attackBarPercent()"
            ></div>
          </div>
        </div>

        <!-- Release indicator -->
        <div class="flex-1">
          <div class="flex items-center justify-between mb-1">
            <span class="text-[9px] text-amber-600/80 uppercase">Release</span>
            <span class="text-[10px] font-mono text-amber-400">{{ formatRelease() }}</span>
          </div>
          <div class="h-1 bg-slate-800 rounded-full overflow-hidden">
            <div
              class="h-full bg-amber-500 transition-all"
              [style.width.%]="releaseBarPercent()"
            ></div>
          </div>
        </div>
      </div>
    </div>
  }
</div>
