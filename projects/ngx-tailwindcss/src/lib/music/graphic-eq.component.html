<div [class]="containerClasses()">
  <!-- Header -->
  <div class="flex items-center justify-between mb-4">
    <div class="flex items-center gap-3">
      <span class="text-sm font-medium" [class]="colors().label"> {{ bandCount() }}-Band EQ </span>
      @if (currentPreset(); as preset) {
        <span class="text-xs px-2 py-0.5 rounded-full bg-white/10" [class]="colors().value">
          {{ preset.name }}
        </span>
      }
    </div>
    <div class="flex items-center gap-2">
      <!-- Preset Dropdown -->
      @if (showPresets() && showPresetDropdown()) {
        <div class="relative">
          <button
            type="button"
            class="text-xs px-2 py-1 rounded flex items-center gap-1 hover:bg-white/10 transition-colors"
            [class]="colors().label"
            (click)="togglePresetMenu()"
            [disabled]="disabled()"
          >
            <span>Presets</span>
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 9l-7 7-7-7"
              />
            </svg>
          </button>

          <!-- Preset Menu -->
          @if (showPresetMenu()) {
            <div
              class="absolute right-0 top-full mt-1 w-64 max-h-80 overflow-auto rounded-lg shadow-xl z-50 border"
              [class]="colors().background"
              [class.border-slate-700]="variant() !== 'minimal'"
              [class.border-slate-200]="variant() === 'minimal'"
            >
              <!-- Search -->
              <div class="p-2 border-b border-white/10">
                <input
                  type="text"
                  placeholder="Search presets..."
                  class="w-full px-2 py-1 text-xs rounded bg-white/10 border-0 outline-none"
                  [class]="colors().value"
                  [value]="presetSearchQuery()"
                  (input)="onPresetSearch($event)"
                />
              </div>

              <!-- Preset Categories -->
              @for (category of presetCategories(); track category) {
                @if (presetsByCategory().get(category); as categoryPresets) {
                  @if (categoryPresets.length > 0) {
                    <div class="py-1">
                      <div
                        class="px-3 py-1 text-[10px] uppercase tracking-wider opacity-50"
                        [class]="colors().label"
                      >
                        {{ categoryNames[category] }}
                      </div>
                      @for (preset of categoryPresets; track preset.id) {
                        <button
                          type="button"
                          class="w-full px-3 py-1.5 text-left text-xs hover:bg-white/10 transition-colors flex items-center justify-between"
                          [class]="colors().value"
                          [class.bg-white/5]="isPresetActive(preset)"
                          (click)="applyPreset(preset)"
                        >
                          <div>
                            <div class="font-medium">{{ preset.name }}</div>
                            @if (preset.description) {
                              <div class="text-[10px] opacity-60">{{ preset.description }}</div>
                            }
                          </div>
                          @if (isPresetActive(preset)) {
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                              <path
                                fill-rule="evenodd"
                                d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                clip-rule="evenodd"
                              />
                            </svg>
                          }
                        </button>
                      }
                    </div>
                  }
                }
              }
            </div>

            <!-- Backdrop to close menu -->
            <div class="fixed inset-0 z-40" (click)="closePresetMenu()"></div>
          }
        </div>
      }

      <button
        type="button"
        class="text-xs px-2 py-1 rounded hover:bg-white/10 transition-colors"
        [class]="colors().label"
        (click)="resetAll()"
        [disabled]="disabled()"
      >
        Reset
      </button>
    </div>
  </div>

  <!-- Quick Preset Buttons -->
  @if (showPresets() && !showPresetDropdown()) {
    <div class="flex flex-wrap gap-1 mb-4">
      @for (preset of quickPresets(); track preset.id) {
        <button
          type="button"
          class="text-[10px] px-2 py-1 rounded transition-colors"
          [class]="
            isPresetActive(preset) ? colors().fill + ' text-white' : 'bg-white/10 ' + colors().label
          "
          (click)="applyPreset(preset)"
          [disabled]="disabled()"
        >
          {{ preset.name }}
        </button>
      }
    </div>
  }

  <!-- EQ Container -->
  <div class="relative">
    <!-- Curve Overlay -->
    @if (showCurve()) {
      <svg
        class="absolute inset-0 w-full pointer-events-none z-10"
        [attr.height]="sliderHeight()"
        [attr.viewBox]="'0 0 100 ' + sliderHeight()"
        preserveAspectRatio="none"
      >
        <!-- Grid lines -->
        <line
          x1="0"
          [attr.y1]="sliderHeight() / 2"
          x2="100"
          [attr.y2]="sliderHeight() / 2"
          [attr.stroke]="colors().grid"
          stroke-width="1"
          stroke-dasharray="2,2"
        />
        <line
          x1="0"
          [attr.y1]="sliderHeight() / 4"
          x2="100"
          [attr.y2]="sliderHeight() / 4"
          [attr.stroke]="colors().grid"
          stroke-width="0.5"
          stroke-dasharray="2,2"
        />
        <line
          x1="0"
          [attr.y1]="(sliderHeight() * 3) / 4"
          x2="100"
          [attr.y2]="(sliderHeight() * 3) / 4"
          [attr.stroke]="colors().grid"
          stroke-width="0.5"
          stroke-dasharray="2,2"
        />

        <!-- +6dB / -6dB lines -->
        <line
          x1="0"
          [attr.y1]="sliderHeight() * 0.125"
          x2="100"
          [attr.y2]="sliderHeight() * 0.125"
          [attr.stroke]="colors().grid"
          stroke-width="0.25"
          stroke-dasharray="1,3"
        />
        <line
          x1="0"
          [attr.y1]="sliderHeight() * 0.875"
          x2="100"
          [attr.y2]="sliderHeight() * 0.875"
          [attr.stroke]="colors().grid"
          stroke-width="0.25"
          stroke-dasharray="1,3"
        />

        <!-- Response Curve -->
        <path
          [attr.d]="curvePath()"
          fill="none"
          [attr.stroke]="colors().curve"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        />

        <!-- Filled area under curve -->
        <path
          [attr.d]="
            curvePath() + ' L 100 ' + sliderHeight() / 2 + ' L 0 ' + sliderHeight() / 2 + ' Z'
          "
          [attr.fill]="colors().curve"
          fill-opacity="0.1"
        />
      </svg>
    }

    <!-- Sliders -->
    <div class="flex items-end justify-center gap-1">
      @for (band of bands(); track band.frequency; let i = $index) {
        <div class="flex flex-col items-center">
          <!-- Slider Track -->
          <div
            class="relative rounded-full cursor-pointer"
            [class]="colors().track"
            [style.height.px]="sliderHeight()"
            [style.width]="bandCount() > 15 ? '8px' : bandCount() > 10 ? '12px' : '16px'"
            [attr.data-band]="i"
            (mousedown)="onBandMouseDown($event, i)"
            (touchstart)="onBandTouchStart($event, i)"
            (dblclick)="resetBand(i)"
            [title]="'Double-click to reset ' + band.label"
          >
            <!-- Center line (0 dB) -->
            <div
              class="absolute left-0 right-0 h-px bg-white/30"
              [style.top.px]="sliderHeight() / 2"
            ></div>

            <!-- Fill -->
            <div
              class="absolute left-0 right-0 rounded-full transition-all duration-75"
              [class]="colors().fill"
              [style.height]="getBandFillHeight(band.gain)"
              [style.top]="getBandFillPosition(band.gain)"
            ></div>

            <!-- Slider Thumb -->
            <div
              class="absolute left-1/2 -translate-x-1/2 w-full rounded-full shadow-md transition-all duration-75"
              [class]="colors().slider"
              [class.ring-2]="draggingBand() === i"
              [class.ring-white/50]="draggingBand() === i"
              [style.height]="bandCount() > 15 ? '6px' : '8px'"
              [style.top.px]="
                (1 - (band.gain - minGain()) / (maxGain() - minGain())) * sliderHeight() -
                (bandCount() > 15 ? 3 : 4)
              "
            ></div>
          </div>

          <!-- Value -->
          @if (showValues()) {
            <span
              class="text-[9px] font-mono mt-1 min-w-[24px] text-center"
              [class]="colors().value"
              [class.text-green-400]="band.gain > 0 && variant() !== 'minimal'"
              [class.text-red-400]="band.gain < 0 && variant() !== 'minimal'"
            >
              {{ band.gain > 0 ? '+' : '' }}{{ band.gain.toFixed(1) }}
            </span>
          }

          <!-- Frequency Label -->
          @if (showLabels()) {
            <span
              class="text-[9px] font-mono mt-1"
              [class]="colors().label"
              [class.font-bold]="band.gain !== 0"
            >
              {{ band.label }}
            </span>
          }
        </div>
      }
    </div>

    <!-- Gain Scale -->
    <div
      class="absolute -left-8 top-0 flex flex-col justify-between text-[9px] font-mono"
      [class]="colors().label"
      [style.height.px]="sliderHeight()"
    >
      <span>+{{ maxGain() }}</span>
      <span class="opacity-50">+6</span>
      <span>0</span>
      <span class="opacity-50">-6</span>
      <span>{{ minGain() }}</span>
    </div>
  </div>

  <!-- Curve Visualization Legend -->
  @if (showCurve()) {
    <div class="flex items-center justify-center gap-4 mt-3 text-[10px]" [class]="colors().label">
      <div class="flex items-center gap-1">
        <div class="w-3 h-0.5 rounded" [style.background]="colors().curve"></div>
        <span>Response Curve</span>
      </div>
      <div class="flex items-center gap-1">
        <div class="w-2 h-2 rounded-full" [class]="colors().fill"></div>
        <span>Boost</span>
      </div>
      <div class="flex items-center gap-1">
        <div class="w-2 h-2 rounded-full" [class]="colors().slider"></div>
        <span>Cut</span>
      </div>
    </div>
  }
</div>
