<div [class]="containerClasses()">
  <!-- Label (top) -->
  @if (label() && labelPosition() === 'top') {
    <div [class]="labelClasses()">{{ label() }}</div>
  }

  <!-- Meter display -->
  <div [class]="meterContainerClasses()">
    @if (orientation() === 'vertical') {
      <!-- Vertical meter -->
      <div class="flex gap-1" [style.height.px]="height()">
        @for (channel of channels(); track channel) {
          <div class="relative flex flex-col-reverse" [style.width.px]="barWidth()">
            <!-- Scale marks (left side of first channel) -->
            @if (showScale() && channel === 0) {
              <div
                class="absolute -left-6 top-0 bottom-0 flex flex-col justify-between text-[9px] text-slate-500 dark:text-slate-400 font-mono"
              >
                @for (mark of scaleMarks(); track mark.value) {
                  <span class="-translate-y-1/2">{{ mark.label }}</span>
                }
              </div>
            }

            <!-- Segments -->
            @for (segment of segments(); track segment.index) {
              <div
                [class]="segmentClasses(segment, channelValues()[channel])"
                [style.height.%]="100 / segmentCount()"
                [style.marginBottom.px]="segment.index < segmentCount() - 1 ? gapSize() : 0"
              ></div>
            }

            <!-- Peak indicator -->
            @if (showPeak() && peakValues()[channel] > 0) {
              <div
                [class]="
                  'absolute left-0 right-0 h-1 transition-all duration-75 ' +
                  peakClasses(peakValues()[channel])
                "
                [style.bottom.%]="(peakValues()[channel] / max()) * 100"
              ></div>
            }

            <!-- RMS indicator (for 'both' mode) -->
            @if (showRmsBar() && rmsValues()[channel] > 0) {
              <div
                class="absolute left-0 right-0 h-0.5 bg-cyan-400 dark:bg-cyan-300 transition-all duration-150"
                [style.bottom.%]="getRmsPosition(channel)"
                title="RMS Level"
              ></div>
            }

            <!-- Clip indicator -->
            @if (showClip() && clipStates()[channel]) {
              <div
                class="absolute -top-1 left-0 right-0 h-2 bg-red-500 rounded-sm animate-pulse cursor-pointer"
                (click)="resetClip(channel)"
                title="Click to reset"
              ></div>
            }
          </div>
        }
      </div>
    } @else {
      <!-- Horizontal meter -->
      <div class="flex flex-col gap-1" [style.width.px]="width()">
        @for (channel of channels(); track channel) {
          <div class="relative flex" [style.height.px]="barWidth()">
            <!-- Segments -->
            @for (segment of segments(); track segment.index) {
              <div
                [class]="segmentClasses(segment, channelValues()[channel])"
                [style.width.%]="100 / segmentCount()"
                [style.marginRight.px]="segment.index < segmentCount() - 1 ? gapSize() : 0"
              ></div>
            }

            <!-- Peak indicator -->
            @if (showPeak() && peakValues()[channel] > 0) {
              <div
                [class]="
                  'absolute top-0 bottom-0 w-1 transition-all duration-75 ' +
                  peakClasses(peakValues()[channel])
                "
                [style.left.%]="(peakValues()[channel] / max()) * 100"
              ></div>
            }

            <!-- RMS indicator (for 'both' mode) -->
            @if (showRmsBar() && rmsValues()[channel] > 0) {
              <div
                class="absolute top-0 bottom-0 w-0.5 bg-cyan-400 dark:bg-cyan-300 transition-all duration-150"
                [style.left.%]="getRmsPosition(channel)"
                title="RMS Level"
              ></div>
            }

            <!-- Clip indicator -->
            @if (showClip() && clipStates()[channel]) {
              <div
                class="absolute -right-1 top-0 bottom-0 w-2 bg-red-500 rounded-sm animate-pulse cursor-pointer"
                (click)="resetClip(channel)"
                title="Click to reset"
              ></div>
            }
          </div>
        }

        <!-- Scale marks (bottom) -->
        @if (showScale()) {
          <div
            class="flex justify-between text-[9px] text-slate-500 dark:text-slate-400 font-mono mt-1"
          >
            @for (mark of horizontalScaleMarks(); track mark.value) {
              <span>{{ mark.label }}</span>
            }
          </div>
        }
      </div>
    }
  </div>

  <!-- Label (bottom) -->
  @if (label() && labelPosition() === 'bottom') {
    <div [class]="labelClasses()">{{ label() }}</div>
  }

  <!-- Channel labels -->
  @if (showChannelLabels() && stereo()) {
    <div class="flex justify-center gap-4 mt-1 text-xs text-slate-500 dark:text-slate-400">
      <span>L</span>
      <span>R</span>
    </div>
  }

  <!-- Mode indicator -->
  @if (meterMode() !== 'peak') {
    <div class="text-[9px] font-mono text-slate-500 dark:text-slate-400 mt-1 text-center">
      {{ meterModeLabel() }}
      @if (showRmsBar()) {
        <span
          class="inline-block w-2 h-0.5 bg-cyan-400 ml-1 align-middle"
          title="RMS indicator"
        ></span>
      }
    </div>
  }
</div>
